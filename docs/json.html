<!-- Generated at compile-time by MiscTools Builder on 2025-12-24T10:29:12.869Z -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/favicon.png" type="image/png">
    <title>Deltamod MiscTools - Create Deltamod JSON file</title>
    <link rel="stylesheet" href="json.css">
    <link rel="manifest" href="./manifest.json">
</head>
<body>
    <div class="header">
        <h1 id="h1title">Create Deltamod JSON file</h1>
        <p style="margin-bottom: 0;" id="h1desc">Create a meta.json file for use in Deltamod</p>
    </div>
    <div class="main" style="height: calc(100% - 80px); overflow-y: scroll;">
        <b>Create a <code>meta.json</code> file</b>
<br>
<hr>
<div>
    <p><deltamod-icon></deltamod-icon> <deltahub-icon></deltahub-icon> <b>Metadata</b></p>
    <input type="text" placeholder="Mod name (Required)" id="metadata.name">
    <textarea placeholder="Mod description (max. 100 chars) (Required)" id="metadata.description" maxlength="100"></textarea>
    <input type="text" placeholder="Mod authors (Required)" id="metadata.authors">
    <input type="text" placeholder="Mod version (Required)" id="metadata.version">
    <input type="url" name="metadata.url" id="metadata.url" placeholder="Mod website URL">
    <p><deltamod-icon></deltamod-icon> <b>Package ID</b></p>
    <span><i>(This is a required field.)</i></span>
    <div class="pid" style="display: flex; justify-content: left; align-items: center;">
        <input type="text" placeholder="website" id="metadata.packageID.1" oninput="lowercase(this)">
        <span style="margin: 0 5px;">.</span>
        <input type="text" placeholder="mod" id="metadata.packageID.2" oninput="lowercase(this)">
        <span style="margin: 0 5px;">.</span>
        <input type="text" placeholder="author" id="metadata.packageID.3" oninput="lowercase(this)">
    </div>
    <p><deltamod-icon></deltamod-icon> <b>Mod dominant color</b></p>
    <small>(Select a color which goes well with your mod icon. If your mod doesn't have an icon, <button onclick="metaColorBlack()">click here</button>.)</small>
    <br>
    <input type="color" name="metadata.color" id="metadata.color" style="width: 100px; height: 100px;">
    <p><deltamod-icon></deltamod-icon> <b>Target game</b></p>
    <select name="metadata.game" id="metadata.game" oninput="toggleDhubVER()">
        <option value="null" style="display: none;">Select an option </option>
        <option value="toby.deltarune">Deltarune - full version</option>
        <option value="toby.deltarune.demo">Deltarune - demo version</option>
        <option value="toby.undertale">Undertale</option>
        <option value="fans.utyellow">Undertale Yellow</option>
    </select>
    <div class="deltahubTargetVer" style="display: none;">
        <p><deltahub-icon></deltahub-icon> <b>DELTARUNE target version</b></p>
        <input type="text" placeholder="Target DELTARUNE version" id="deltaruneTargetVersion">
        <small>Please note that Deltahub does not have support for the new Standard X, and as such doesn't support non-Deltarune games. Keep this field blank if making a non-DELTARUNE mod.</small>
        <p><deltahub-icon></deltahub-icon> <b>Mod tags</b></p>
        <div class="checkboxArray">
            <label><input type="checkbox" name="metadata.tags" data-value="translation"> translation</label>
            <label><input type="checkbox" name="metadata.tags" data-value="text"> text</label>
            <label><input type="checkbox" name="metadata.tags" data-value="customization"> customization</label>
            <label><input type="checkbox" name="metadata.tags" data-value="gameplay"> gameplay</label>
            <label><input type="checkbox" name="metadata.tags" data-value="other"> other</label>
        </div>
    </div>
    <p><deltamod-icon></deltamod-icon> <b>Mod needed files</b></p>
    <table>
        <colgroup>
            <col style="width: 40%;">
            <col style="width: 40%;">
            <col style="width: 20%;">
        </colgroup>
        <thead>
            <tr>
                <th>File path (ex. <code>./chapter1_windows/data.win</code>)</th>
                <th>File hash</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="fileTableBody">
            <!-- Rows will be added here dynamically -->
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3"><button style="width: 100%; padding: 10px; font-size: 1em; cursor: pointer;" onclick="addNeededFile()">Add</button></td>
            </tr>
        </tfoot>
    </table>
    <br><hr><br>
    <button id="generateBtn" onclick="generateJSON()">Generate JSON file</button>
</div>
    </div>
</body>
<!-- service worker -->
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker
                .register('/worker.js')
                .then((registration) => {
                    console.log('Service Worker registered with scope: ', registration.scope);
                })
                .catch((error) => {
                    console.log('Service Worker registration failed: ', error);
                });
        });
    }

</script>
<script>
    var cachedneededfiles = [];

function addNeededFile(fillName = '', fillHash = '', askQuest = true) {
    var uid = Date.now().toString() + Math.floor(Math.random() * 1000).toString();

    if (askQuest) {
        var importFile = window.confirm('Do you want to import a file to fill in its path and hash? Click "Cancel" to add an empty entry.');
        if (importFile) {
            var fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.onchange = async function(event) {
                var file = event.target.files[0];
                if (file) {
                    var arrayBuffer = await file.arrayBuffer();
                    var hash = await sha256(arrayBuffer);

                    fillName = "./" + file.name;
                    fillHash = hash;

                    addNeededFile(fillName, fillHash, false);

                    window.alert('File imported successfully!\n\nNote that the path generated supposes the file will be in the root of the mod package.');
                }
            };
            fileInput.click();
            return;
        }
    }

    var tbody = document.getElementsByTagName('tbody')[0];
    var newRow = document.createElement('tr');
    
    var td1 = document.createElement('td');
    var input1 = document.createElement('input');
    input1.type = 'text';
    input1.name = 'neededfile';
    input1.placeholder = './path/to/file.ext';
    input1.value = fillName;
    td1.appendChild(input1);

    var td2 = document.createElement('td');
    var input2 = document.createElement('input');
    input2.type = 'text';
    input2.name = 'neededfilehash';
    input2.placeholder = 'SHA256 hash';
    input2.value = fillHash;
    td2.appendChild(input2);

    var td3 = document.createElement('td');
    var removeButton = document.createElement('button');
    removeButton.type = 'button';
    removeButton.style.width = '100%';
    removeButton.style.padding = '5px';
    removeButton.innerText = 'Remove';
    removeButton.onclick = function() {
        tbody.removeChild(newRow);
        cachedneededfiles = cachedneededfiles.filter(item => item.uid !== uid);
    };
    td3.appendChild(removeButton);

    cachedneededfiles.push({pathInput: input1, hashInput: input2, uid: uid});

    newRow.appendChild(td1);
    newRow.appendChild(td2);
    newRow.appendChild(td3);
    tbody.appendChild(newRow);
}

function metaColorBlack() {
    document.getElementById('metadata.color').value = '#000000';
}

// Source - https://stackoverflow.com/a
// Posted by Vitaly Zdanevich, modified by community. See post 'Timeline' for change history
// Edited partially to support file hashing
// Retrieved 2025-12-16, License - CC BY-SA 4.0

async function sha256(msgBuffer) {          
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));        
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}


function generateJSON() {
    function i(id) {
        return document.getElementById(id).value;
    }

    var colorValue = document.getElementById('metadata.color').value;
    function hexToRgb(hex) {
        hex = (hex || '').replace(/^#/, '');
        if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
        if (!/^[0-9a-fA-F]{6}$/.test(hex)) return { r: 0, g: 0, b: 0 };
        const intVal = parseInt(hex, 16);
        return {
            r: (intVal >> 16) & 255,
            g: (intVal >> 8) & 255,
            b: intVal & 255
        };
    }

    colorValue = hexToRgb(colorValue);

    if (
        i('metadata.name').trim().length === 0 ||
        i('metadata.version').trim().length === 0 ||
        i('metadata.description').trim().length === 0 ||
        i('metadata.authors').trim().length === 0 ||
        i('metadata.game').trim() == 'null'
    ) {
        alert('Please fill in all required metadata fields (Name, Version, Description, Authors, Game).');
        return;
    }

    if (i('metadata.packageID.1').trim().length === 0 ||
        i('metadata.packageID.2').trim().length === 0 ||
        i('metadata.packageID.3').trim().length === 0) {
        alert('Please fill in all parts of the Package ID.');
        return;
    }

    var compiledJSON = {
        metadata: {
            name: i('metadata.name'),
            version: i('metadata.version'),
            description: i('metadata.description'),
            author: i('metadata.authors').split(',').map(s => s.trim()).filter(s => s.length > 0),
            url: i('metadata.url'),
            color: { r: colorValue.r, g: colorValue.g, b: colorValue.b },
            tags: document.querySelectorAll('input[name="metadata.tags"]:checked').length > 0 ? Array.from(document.querySelectorAll('input[name="metadata.tags"]:checked')).map(cb => cb.dataset.value) : undefined,
            game: i('metadata.game') || 'toby.deltarune',
            packageID: i('metadata.packageID.1') + '.' + i('metadata.packageID.2') + '.' + i('metadata.packageID.3')
        },
        deltaruneTargetVersion: i('deltaruneTargetVersion'),
        neededFiles: [],
        exporter: {
            tool: 'MiscTools'
        }
    };

    cachedneededfiles.forEach(item => {
        var path = item.pathInput.value.trim();
        var hash = item.hashInput.value.trim();
        if (path.length > 0) {
            compiledJSON.neededFiles.push({file: path, checksum: hash});
        }
    });

    var jsonOutput = JSON.stringify(compiledJSON, null, 4);
    
    var blob = new Blob([jsonOutput], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'meta.json';
    a.click();
    URL.revokeObjectURL(url);
}

function toggleDhubVER() {
    var gameSelect = document.getElementById('metadata.game');
    var dhubVerDiv = document.querySelector('.deltahubTargetVer');
    if (gameSelect.value === 'toby.deltarune' || gameSelect.value === 'toby.deltarune.demo') {
        dhubVerDiv.style.display = 'block';
    } else {
        dhubVerDiv.style.display = 'none';
        document.getElementById('deltaruneTargetVersion').value = '';
    }
}
</script>
</html>